#include <WiFi.h>
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <Firebase_ESP_Client.h>
#include "addons/TokenHelper.h"
#include "addons/RTDBHelper.h"

/* ---------- Wiâ€‘Fi ---------- */
#define WIFI_SSID     "chanchan"
#define WIFI_PASSWORD "00000000"

/* ---------- Firebase / Firestore ---------- */
#define API_KEY        "AIzaSyCIHkTK_SSNpPbjU3FLSGu8fDg7gR38q-s"
#define DATABASE_URL   "https://smart-medi-v0.firebaseio.com"
#define FIREBASE_PROJECT_ID "smart-medi-v0"
#define DATABASE_ID         "(default)"
#define USER_EMAIL    "esp32@smartpillbox.com"
#define USER_PASSWORD "12345678"

/* ---------- I/O ---------- */
#define LED_PIN     17
#define BUZZER_PIN  18
#define BUTTON_PIN  4
#define IR_SENSOR_PIN 36
#define IN1 2
#define IN2 13
#define IN3 25
#define IN4 26

/* ---------- OLED ---------- */
#define SCREEN_WIDTH  128
#define SCREEN_HEIGHT  64
#define OLED_RESET    -1
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);

/* ---------- æ­¥è¿›ç”µæœºåºåˆ— ---------- */
const int stepSequence[8][4] = {
  {1,0,0,0}, {1,1,0,0}, {0,1,0,0}, {0,1,1,0},
  {0,0,1,0}, {0,0,1,1}, {0,0,0,1}, {1,0,0,1}
};

/* ---------- Firebase å¯¹è±¡ ---------- */
FirebaseData fbdo;
FirebaseAuth auth;
FirebaseConfig config;

bool taskDone = false;
unsigned long dataMillis = 0;

/* ---------- æé†’çŠ¶æ€æ§åˆ¶ ---------- */
bool reminderStarted = false;
bool reminderAcknowledged = false;
unsigned long welcomeStartTime = 0;
bool takeMedsDisplayed = false;

/* ---------- IRä¼ æ„Ÿå™¨å’ŒæŒ‰é’®çš„çŠ¶æ€æ£€æµ‹ ---------- */
unsigned long lastButtonCheckTime = 0;
const unsigned long buttonDebounceTime = 500; // é˜²æŠ–åŠ¨æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
unsigned long lastIRCheckTime = 0;
const unsigned long IRCheckInterval = 200; // IRæ£€æµ‹é—´éš”ï¼ˆæ¯«ç§’ï¼‰
int lastButtonState = HIGH;
int lastIRState = LOW;
int irThreshold = 1000; // IRä¼ æ„Ÿå™¨é˜ˆå€¼

/* ========================================================================= */
void setup() {
  Serial.begin(115200);
  Wire.begin(21, 22); // OLED SDA/SCL å¼•è„š

  pinMode(LED_PIN, OUTPUT);
  pinMode(BUZZER_PIN, OUTPUT);
  pinMode(BUTTON_PIN, INPUT_PULLUP);
  pinMode(IR_SENSOR_PIN, INPUT);
  pinMode(IN1, OUTPUT); pinMode(IN2, OUTPUT);
  pinMode(IN3, OUTPUT); pinMode(IN4, OUTPUT);

  Serial.println("ğŸ”§ Booting...");
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
  Serial.print("ğŸ“¡ Connecting to WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\nâœ… WiFi connected.");
  Serial.print("ğŸ“¶ IP Address: ");
  Serial.println(WiFi.localIP());

  // åˆå§‹åŒ–OLED
  if(!display.begin(SSD1306_SWITCHCAPVCC, 0x3D)) {
    Serial.println("SSD1306 allocation failed");
  } else {
    display.clearDisplay();
    display.setTextSize(2);
    display.setTextColor(SSD1306_WHITE);
    display.setCursor(10, 20);
    display.println("WELCOME");
    display.display();
    welcomeStartTime = millis();
  }

  initFirebase();
}

void loop() {
  // è·å–å½“å‰æ—¶é—´
  unsigned long currentMillis = millis();
  
  // æ£€æŸ¥WiFiå’ŒFirebaseè¿æ¥çŠ¶æ€
  if (Firebase.ready() && !taskDone) {
    Serial.println("Firebase ready, checking weekly plans...");
    checkWeeklyPlans();
    taskDone = true;
  }
  
  // æ¯60ç§’æ£€æŸ¥ä¸€æ¬¡Firebaseæ•°æ®
  if (currentMillis - dataMillis > 60000 && Firebase.ready()) {
    dataMillis = currentMillis;
    Serial.println("Periodic check of weekly plans...");
    checkWeeklyPlans();
  }
  
  // æ¬¢è¿æ˜¾ç¤º5ç§’åï¼Œå¦‚æœæœ‰æé†’éœ€è¦è§¦å‘
  if (!reminderStarted && currentMillis - welcomeStartTime >= 5000 && taskDone) {
    // æ­¤å¤„å¯ä»¥æ”¾ç½®æ£€æŸ¥æ˜¯å¦æœ‰æé†’éœ€è¦ç«‹å³è§¦å‘çš„é€»è¾‘
    // è¿™é‡Œå¯ä»¥ç›´æ¥æ£€æŸ¥Firebaseè¿”å›çš„ç»“æœå†³å®šæ˜¯å¦è§¦å‘
  }
  
  // å¦‚æœæé†’å·²æ¿€æ´»ä½†å°šæœªç¡®è®¤ï¼Œæ£€æµ‹IRä¼ æ„Ÿå™¨å’ŒæŒ‰é’®çŠ¶æ€
  if (reminderStarted && !reminderAcknowledged) {
    // æ£€æŸ¥IRä¼ æ„Ÿå™¨çŠ¶æ€ï¼ˆæ¯200msæ£€æŸ¥ä¸€æ¬¡ä»¥å‡å°‘å™ªå£°ï¼‰
    if (currentMillis - lastIRCheckTime >= IRCheckInterval) {
      lastIRCheckTime = currentMillis;
      int irValue = analogRead(IR_SENSOR_PIN);
      Serial.print("IR Sensor Value: ");
      Serial.println(irValue);
      
      // æ£€æµ‹æ˜¯å¦æœ‰ç‰©ä½“ç§»åŠ¨ï¼ˆå½“IRå€¼è¶…è¿‡é˜ˆå€¼ï¼‰
      if (irValue > irThreshold) {
        handleMedicationTaken();
      }
    }
    
    // æ£€æŸ¥æŒ‰é’®çŠ¶æ€ï¼ˆå¸¦é˜²æŠ–åŠ¨ï¼‰
    int buttonState = digitalRead(BUTTON_PIN);
    if (buttonState == LOW && lastButtonState == HIGH && 
        currentMillis - lastButtonCheckTime > buttonDebounceTime) {
      lastButtonCheckTime = currentMillis;
      Serial.println("Button pressed");
      handleMedicationTaken();
    }
    lastButtonState = buttonState;
    
    // åœ¨æœªç¡®è®¤çš„æƒ…å†µä¸‹æŒç»­æé†’
    if (!reminderAcknowledged) {
      // LEDé—ªçƒå®ç°
      if (currentMillis % 1000 < 500) {
        digitalWrite(LED_PIN, HIGH);
      } else {
        digitalWrite(LED_PIN, LOW);
      }
      
      // èœ‚é¸£å™¨é—´æ­‡æ€§æç¤ºï¼ˆæ¯3ç§’é¸£å“1ç§’ï¼‰
      if (currentMillis % 4000 < 1000) {
        tone(BUZZER_PIN, 1000);
      } else {
        noTone(BUZZER_PIN);
      }
      
      // ç¡®ä¿"Take meds"æ˜¾ç¤º
      showTakeMeds();
    }
  }
}

/* ========================================================================= */
// å¤„ç†è¯ç‰©å·²å–å‡ºäº‹ä»¶
void handleMedicationTaken() {
  Serial.println("âœ… Medication taken confirmed!");
  reminderAcknowledged = true;
  deactivateReminder();
  
  // æ›´æ–°æ˜¾ç¤º
  display.clearDisplay();
  display.setCursor(30, 20);
  display.setTextSize(2);
  display.setTextColor(SSD1306_WHITE);
  display.println("DONE");
  display.display();
  
  // è®°å½•ç”¨è¯è®°å½•åˆ°Firebase
  const String today = getCurrentDate(); // å®é™…åº”è¯¥ä»RTCæˆ–NTPè·å–
  const String now = getCurrentTime();   // å®é™…åº”è¯¥ä»RTCæˆ–NTPè·å–
  logMedicationRecord(today, now, "taken");
  
  // 5ç§’åæ¢å¤æ¬¢è¿å±å¹•
  delay(5000);
  display.clearDisplay();
  display.setCursor(10, 20);
  display.setTextSize(2);
  display.setTextColor(SSD1306_WHITE);
  display.println("READY");
  display.display();
}

// è·å–å½“å‰æ—¥æœŸï¼ˆå®é™…åº”è¯¥ä»RTCæˆ–NTPè·å–ï¼‰
String getCurrentDate() {
  return "2025-05-13"; // è¿™é‡Œåº”æ”¹ä¸ºçœŸå®è·å–æ—¥æœŸçš„ä»£ç 
}

// è·å–å½“å‰æ—¶é—´ï¼ˆå®é™…åº”è¯¥ä»RTCæˆ–NTPè·å–ï¼‰
String getCurrentTime() {
  return "14:34"; // è¿™é‡Œåº”æ”¹ä¸ºçœŸå®è·å–æ—¶é—´çš„ä»£ç 
}

/* ========================================================================= */
void initFirebase() {
  Serial.println("Initializing Firebase...");
  
  config.api_key = API_KEY;
  config.database_url = DATABASE_URL;
  
  // è®¾ç½®ç™»å½•å‡­æ®
  auth.user.email = USER_EMAIL;
  auth.user.password = USER_PASSWORD;
  
  // æ·»åŠ å›è°ƒå‡½æ•°
  config.token_status_callback = tokenStatusCallback;
  
  Firebase.begin(&config, &auth);
  Firebase.reconnectWiFi(true);
  
  Serial.println("ğŸ”¥ Firebase initialized.");
  
  // ç­‰å¾…è®¤è¯å®Œæˆ
  Serial.println("Waiting for authentication...");
  int authAttempts = 0;
  while (Firebase.isTokenExpired() && authAttempts < 30) {
    Serial.print(".");
    delay(1000);
    authAttempts++;
  }
  
  if (Firebase.isTokenExpired()) {
    Serial.println("\nâŒ Authentication failed after 30 seconds!");
  } else {
    Serial.println("\nâœ… Firebase authenticated!");
  }
}

/* ========================================================================= */
void checkWeeklyPlans() {
  // å®é™…åº”ç”¨ä¸­åº”è¯¥ä½¿ç”¨RTCæˆ–NTPè·å–å½“å‰æ—¶é—´
  const String today = getCurrentDate();
  const String now = getCurrentTime();
  
  Serial.println("Checking weekly plans for " + today + " " + now);

  // ä½¿ç”¨æ­£ç¡®çš„é›†åˆè·¯å¾„æ ¼å¼
  String collectionPath = "weeklyPlans";
  
  Serial.println("Attempting to list documents in collection: " + collectionPath);
  
  if (Firebase.Firestore.listDocuments(&fbdo, FIREBASE_PROJECT_ID, "", 
                                       collectionPath.c_str(), 10, 
                                       "", "", "", false)) {
    
    Serial.println("Retrieved documents list");
    Serial.println("Raw payload: " + fbdo.payload());
    
    // å°†å“åº”æ•°æ®è§£æä¸ºJSON
    FirebaseJson payload;
    payload.setJsonData(fbdo.payload());
    
    // è·å–æ–‡æ¡£æ•°é‡
    FirebaseJsonData documentsArray;
    payload.get(documentsArray, "documents");
    
    if (documentsArray.success && documentsArray.type == "array") {
      FirebaseJsonArray docArray;
      docArray.setJsonArrayData(documentsArray.stringValue);
      
      Serial.print("Found ");
      Serial.print(docArray.size());
      Serial.println(" documents");
      
      // éå†æ¯ä¸ªæ–‡æ¡£
      for (size_t i = 0; i < docArray.size(); i++) {
        FirebaseJsonData docItem;
        docArray.get(docItem, i);
        
        if (docItem.success) {
          FirebaseJson docJson;
          docJson.setJsonData(docItem.stringValue);
          
          // è·å–æ–‡æ¡£åç§°/è·¯å¾„
          FirebaseJsonData nameData;
          docJson.get(nameData, "name");
          
          if (nameData.success) {
            String docPath = nameData.stringValue;
            Serial.println("ğŸ“„ Document path: " + docPath);
            
            // ä»è·¯å¾„ä¸­æå–æ–‡æ¡£ID
            int lastSlash = docPath.lastIndexOf('/');
            String docId = (lastSlash != -1) ? docPath.substring(lastSlash + 1) : docPath;
            
            // è·å–å•ä¸ªæ–‡æ¡£è¯¦æƒ…
            Serial.println("Attempting to get document: " + docId);
            
            // ä½¿ç”¨æ­£ç¡®çš„æ–‡æ¡£è·¯å¾„æ ¼å¼
            if (Firebase.Firestore.getDocument(&fbdo, FIREBASE_PROJECT_ID, "", 
                                              (collectionPath + "/" + docId).c_str(), "")) {
              
              Serial.println("Retrieved document details");
              Serial.println("Document payload: " + fbdo.payload());
              
              FirebaseJson contentJson;
              contentJson.setJsonData(fbdo.payload());
              
              // ç›´æ¥æå–å­—æ®µå€¼
              FirebaseJsonData dateField, timeField;
              contentJson.get(dateField, "fields/date/stringValue");
              contentJson.get(timeField, "fields/time/stringValue");
              
              String date = dateField.success ? dateField.stringValue : "Unknown date";
              String time = timeField.success ? timeField.stringValue : "Unknown time";
              
              Serial.print("ğŸ“… Date = "); Serial.print(date);
              Serial.print(" | ğŸ•’ Time = "); Serial.println(time);
              
              // æ‰“å°JSONç»“æ„ä»¥ä¾¿è°ƒè¯•
              Serial.println("Document structure:");
              printJsonStructure(contentJson, "");
              
              if (date == today && time == now) {
                Serial.println("ğŸ”” Reminder triggered!");
                
                // ä½¿ç”¨æ–°çš„ç¡¬ä»¶æ§åˆ¶é€»è¾‘è§¦å‘æé†’
                reminderStarted = true;
                reminderAcknowledged = false;
                takeMedsDisplayed = false;
                activateReminder();
                showTakeMeds();
              }
            } else {
              Serial.println("âŒ getDocument error: " + fbdo.errorReason());
            }
          } else {
            Serial.println("âŒ Could not extract document name");
          }
        } else {
          Serial.println("âŒ Could not extract document at index " + String(i));
        }
      }
    } else {
      Serial.println("âŒ No documents found or array parsing error");
      Serial.println("Type: " + String(documentsArray.type));
      Serial.println("Success: " + String(documentsArray.success));
    }
  } else {
    Serial.println("âŒ listDocuments error: " + fbdo.errorReason());
    Serial.println("Error code: " + String(fbdo.errorCode()));
  }
}

// è°ƒè¯•åŠ©æ‰‹ï¼šæ‰“å°JSONç»“æ„
void printJsonStructure(FirebaseJson &json, String path) {
  Serial.println("Examining JSON structure at path: " + path);
  
  FirebaseJsonData result;
  size_t len = json.iteratorBegin();
  String key, value;
  int type = 0;
  
  for (size_t i = 0; i < len; i++) {
    json.iteratorGet(i, type, key, value);
    Serial.print(i);
    Serial.print(": ");
    Serial.print("Type: ");
    Serial.print(type == FirebaseJson::JSON_OBJECT ? "object" : 
                type == FirebaseJson::JSON_ARRAY ? "array" : 
                type == FirebaseJson::JSON_STRING ? "string" : 
                type == FirebaseJson::JSON_INT ? "int" : 
                type == FirebaseJson::JSON_FLOAT ? "float" : 
                type == FirebaseJson::JSON_DOUBLE ? "double" : 
                type == FirebaseJson::JSON_BOOL ? "boolean" : 
                type == FirebaseJson::JSON_NULL ? "null" : "unknown");
    Serial.print(", Key: ");
    Serial.print(key);
    Serial.print(", Value: ");
    Serial.println(value.length() > 30 ? value.substring(0, 30) + "..." : value);
  }
  
  json.iteratorEnd();
}

// æ˜¾ç¤º"Take meds"æç¤º
void showTakeMeds() {
  if (!takeMedsDisplayed) {
    display.clearDisplay();
    display.setCursor(10, 20);
    display.setTextSize(2);
    display.setTextColor(SSD1306_WHITE);
    display.println("Take meds");
    display.display();
    takeMedsDisplayed = true;
  }
}

// æ¿€æ´»æé†’
void activateReminder() {
  digitalWrite(LED_PIN, HIGH);
  tone(BUZZER_PIN, 1000);
  rotateStepper60Degrees();
  
  Serial.println("â° Reminder activated!");
  Serial.println("Waiting for user to take medication...");
  Serial.println("- Press button or remove medication to confirm");
}

// åœæ­¢æé†’
void deactivateReminder() {
  digitalWrite(LED_PIN, LOW);
  noTone(BUZZER_PIN);
}

// æ­¥è¿›ç”µæœºæ—‹è½¬60åº¦
void rotateStepper60Degrees() {
  int steps = 682; // 60 åº¦ â‰ˆ 682 æ­¥
  for (int i = 0; i < steps; i++) {
    int seq = i % 8;
    digitalWrite(IN1, stepSequence[seq][0]);
    digitalWrite(IN2, stepSequence[seq][1]);
    digitalWrite(IN3, stepSequence[seq][2]);
    digitalWrite(IN4, stepSequence[seq][3]);
    delay(2);
  }
  digitalWrite(IN1, LOW);
  digitalWrite(IN2, LOW);
  digitalWrite(IN3, LOW);
  digitalWrite(IN4, LOW);
}

/* ========================================================================= */
void logMedicationRecord(String date, String time, String status) {
  FirebaseJson content;
  content.set("fields/date/stringValue", date);
  content.set("fields/time/stringValue", time);
  content.set("fields/status/stringValue", status);

  String jsonString;
  content.toString(jsonString);

  const char *collectionId = "medicationRecords";
  String docId = "record_" + String(millis());

  if (!Firebase.Firestore.createDocument(
        &fbdo,
        FIREBASE_PROJECT_ID,
        "",  // åˆ é™¤DATABASE_ID
        collectionId,
        docId.c_str(),
        jsonString.c_str(),
        "")) {
    Serial.println("âŒ logMedicationRecord error: " + fbdo.errorReason());
  } else {
    Serial.println("âœ… Medication record logged.");
  }
}
